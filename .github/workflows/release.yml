name: Release Obsidian plugin

on:
    push:
        tags:
            - "[0-9]+.[0-9]+.[0-9]+*" # åŒ¹é…ç±»ä¼¼ 1.0.0 æˆ– 1.0.0-beta.1 çš„æ ¼å¼

permissions:
    contents: write

env:
    PLUGIN_NAME: xxx(replace all occurrences of xxx with your plugin name)

jobs:
    build:
        runs-on: ubuntu-22.04

        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0 # è·å–å®Œæ•´çš„gitå†å²

            - name: Use Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: "18.x"

            - name: Prepare manifest
              id: prepare_manifest
              run: |
                  if [[ ${{ github.ref }} == *"beta"* ]]; then
                    cp manifest-beta.json manifest.json
                  fi

            - name: Build
              id: build
              run: |
                  npm install -g yarn
                  yarn
                  yarn run build --if-present
                  mkdir ${{ env.PLUGIN_NAME }}
                  cp main.js manifest.json styles.css ${{ env.PLUGIN_NAME }}
                  zip -r ${{ env.PLUGIN_NAME }}.zip ${{ env.PLUGIN_NAME }}
                  ls
                  echo "tag_name=$(git tag --sort version:refname | tail -n 1)" >> $GITHUB_OUTPUT

                  - name: Generate Changelog
                  id: changelog
                  run: |
                      # å®šä¹‰éƒ¨åˆ†åç§°
                      declare -A SECTION_MAP
                      SECTION_MAP["BREAKING CHANGES"]="BREAKING CHANGES"
                      SECTION_MAP["Features"]="Features"
                      SECTION_MAP["Bug Fixes"]="Bug Fixes"
                      SECTION_MAP["Documentation"]="Documentation"
                      SECTION_MAP["Styles"]="Styles"
                      SECTION_MAP["Refactors"]="Refactors"
                      SECTION_MAP["Performance"]="Performance"
                      SECTION_MAP["Tests"]="Tests"
                      SECTION_MAP["Build"]="Build"
                      SECTION_MAP["CI"]="CI"
                      SECTION_MAP["Chore"]="Chore"
                      SECTION_MAP["Reverts"]="Reverts"
    
                      # å®šä¹‰ä¸­æ–‡ç¿»è¯‘
                      declare -A ZH_SECTION_MAP
                      ZH_SECTION_MAP["BREAKING CHANGES"]="ç ´åæ€§å˜æ›´"
                      ZH_SECTION_MAP["Features"]="æ–°åŠŸèƒ½"
                      ZH_SECTION_MAP["Bug Fixes"]="ä¿®å¤"
                      ZH_SECTION_MAP["Documentation"]="æ–‡æ¡£"
                      ZH_SECTION_MAP["Styles"]="æ ·å¼"
                      ZH_SECTION_MAP["Refactors"]="é‡æ„"
                      ZH_SECTION_MAP["Performance"]="æ€§èƒ½ä¼˜åŒ–"
                      ZH_SECTION_MAP["Tests"]="æµ‹è¯•"
                      ZH_SECTION_MAP["Build"]="æ„å»º"
                      ZH_SECTION_MAP["CI"]="æŒç»­é›†æˆ"
                      ZH_SECTION_MAP["Chore"]="æ‚é¡¹"
                      ZH_SECTION_MAP["Reverts"]="å›é€€"
    
                      # åˆå§‹åŒ– changelog æ–‡ä»¶
                      CHANGELOG_EN="CHANGELOG.md"
                      CHANGELOG_ZH="CHANGELOG-zh.md"
                      TEMP_CHANGELOG="temp_changelog.md"
    
                      # è·å–å½“å‰ç‰ˆæœ¬å·ï¼ˆä» git tagï¼‰
                      CURRENT_VERSION=$(git tag --sort version:refname | tail -n 1)
                      echo "Current version: $CURRENT_VERSION"
    
                      # ä½¿ç”¨ awk æå–ç‰¹å®šç‰ˆæœ¬çš„ changelog å†…å®¹
                      extract_changelog() {
                        local changelog_file=$1
                        local output_file=$2
                        local is_chinese=$3
                        local target_version=$4
                        
                        > "$output_file"  # åˆå§‹åŒ–ç©ºæ–‡ä»¶
                        
                        # ç¡®å®šç‰ˆæœ¬çš„æ ‡é¢˜çº§åˆ« (# æˆ– ##)
                        # åˆ†è§£ç‰ˆæœ¬å·ï¼Œæ£€æŸ¥æ˜¯å¦ä¸ºå°ç‰ˆæœ¬
                        IFS='.' read -r major minor patch <<< "$target_version"
                        # å¦‚æœpatchä¸æ˜¯0ï¼Œé‚£ä¹ˆæ˜¯å°ç‰ˆæœ¬ï¼Œä½¿ç”¨äºŒçº§æ ‡é¢˜ (##)
                        if [[ -n "$patch" && "$patch" != "0" ]]; then
                          local title_level="##"
                        else
                          # å¤§ç‰ˆæœ¬æˆ–æ¬¡ç‰ˆæœ¬ï¼Œä½¿ç”¨ä¸€çº§æ ‡é¢˜ (#)
                          local title_level="#"
                        fi
                        
                        echo "Looking for version $target_version with title level: $title_level"
                        
                        # ä½¿ç”¨ awk æå–ç›®æ ‡ç‰ˆæœ¬çš„å†…å®¹åˆ°ä¸´æ—¶æ–‡ä»¶
                        awk -v version="$target_version" -v level="$title_level" '
                        BEGIN { found = 0; printing = 0; }
                        
                        # å½“æ‰¾åˆ°ç›®æ ‡ç‰ˆæœ¬æ ‡é¢˜æ—¶
                        $0 ~ "^" level " +\\[" version "\\]" { 
                          found = 1; 
                          printing = 1; 
                          next;  # è·³è¿‡ç‰ˆæœ¬æ ‡é¢˜è¡Œ
                        }
                        
                        # å½“æ‰¾åˆ°ä¸‹ä¸€ä¸ªç‰ˆæœ¬æ ‡é¢˜æ—¶åœæ­¢æ‰“å°
                        printing && $0 ~ "^#+ +\\[" { 
                          printing = 0; 
                        }
                        
                        # æ‰“å°åŒ¹é…åˆ°çš„å†…å®¹
                        printing { 
                          print; 
                        }
                        
                        # æ–‡ä»¶ç»“æŸæ—¶ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°ç›®æ ‡ç‰ˆæœ¬ï¼Œè¾“å‡ºè­¦å‘Š
                        END { 
                          if (!found) {
                            print "Warning: Version " version " not found with title level " level > "/dev/stderr";
                            exit 1;
                          }
                        }' "$changelog_file" > "temp_version_content.md"
                        
                        # æ£€æŸ¥æå–å†…å®¹
                        if [ ! -s "temp_version_content.md" ]; then
                          echo "Warning: No content found for version $target_version in $changelog_file" >&2
                          echo -e "## Changes\n\nNo changelog found for version $target_version.\n" >> "$output_file"
                        else
                          echo "Successfully extracted changelog for version $target_version"
                          echo -e "## Changes\n" >> "$output_file"
                          cat "temp_version_content.md" >> "$output_file"
                        fi
                        
                        # æ·»åŠ å®‰è£…è¯´æ˜
                        if [ "$is_chinese" = true ]; then
                          echo -e "\n## å¦‚ä½•å®‰è£…\n" >> "$output_file"
                          echo -e "1. ä¸‹è½½ \`xxx.zip\` å‹ç¼©æ–‡ä»¶" >> "$output_file"
                          echo -e "2. è§£å‹åˆ°ä½ çš„ Obsidian åº“çš„æ’ä»¶æ–‡ä»¶å¤¹å†…: \`<vault>/.obsidian/plugins/xxx/\`" >> "$output_file"
                          echo -e "3. é‡å¯ Obsidian" >> "$output_file"
                          echo -e "4. åœ¨è®¾ç½®ä¸­å¯ç”¨ **Yearly Glance**" >> "$output_file"
                        else
                          echo -e "\n## Installation\n" >> "$output_file"
                          echo -e "1. Download the files from the Assets section below" >> "$output_file"
                          echo -e "2. Copy them to your vault's plugins folder: \`<vault>/.obsidian/plugins/xxx/\`" >> "$output_file"
                          echo -e "3. Reload Obsidian" >> "$output_file"
                          echo -e "4. Enable **Yearly Glance** plugin in settings" >> "$output_file"
                        fi
                      }
    
                      # å¤„ç†è‹±æ–‡ changelog
                      if [ -f "$CHANGELOG_EN" ]; then
                        extract_changelog "$CHANGELOG_EN" "en_$TEMP_CHANGELOG" false "$CURRENT_VERSION"
                      else
                        echo "è‹±æ–‡ changelog æ–‡ä»¶æœªæ‰¾åˆ°ã€‚ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆã€‚"
                        echo -e "## Changes\n\nNo changelog available.\n\n## Installation\n\n1. Download the files from the Assets section below\n2. Copy them to your vault's plugins folder: \`<vault>/.obsidian/plugins/xxx/\`\n3. Reload Obsidian\n4. Enable plugin in settings" > "en_$TEMP_CHANGELOG"
                      fi
    
                      # å¤„ç†ä¸­æ–‡ changelog
                      if [ -f "$CHANGELOG_ZH" ]; then
                        extract_changelog "$CHANGELOG_ZH" "zh_$TEMP_CHANGELOG" true "$CURRENT_VERSION"
                        
                        # åˆå¹¶ä¸¤ä¸ª changelogs
                        echo -e "# English Changelog\n" > "$TEMP_CHANGELOG"
                        cat "en_$TEMP_CHANGELOG" >> "$TEMP_CHANGELOG"
                        echo -e "\n\n___\n\n# ä¸­æ–‡æ›´æ–°æ—¥å¿—\n" >> "$TEMP_CHANGELOG"
                        cat "zh_$TEMP_CHANGELOG" >> "$TEMP_CHANGELOG"
                      else
                        # å¦‚æœæ²¡æœ‰ä¸­æ–‡ changelogï¼Œåªä½¿ç”¨è‹±æ–‡ç‰ˆæœ¬
                        cp "en_$TEMP_CHANGELOG" "$TEMP_CHANGELOG"
                      fi
    
                      # è¾“å‡º changelog ç»™ GitHub Actions
                      echo "changelog<<EOF" >> $GITHUB_OUTPUT
                      cat "$TEMP_CHANGELOG" >> $GITHUB_OUTPUT
                      echo "EOF" >> $GITHUB_OUTPUT

            - name: Create Release
              id: create_release
              uses: actions/create-release@v1
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  tag_name: ${{ github.ref }}
                  release_name: ${{ github.ref }}
                  draft: false
                  prerelease: ${{ contains(github.ref, 'beta') }}
                  body: |
                      ${{ contains(github.ref, 'beta') && 'ğŸš§ This is a beta release' || 'ğŸ‰ This is a stable release' }}

                      **Version:** ${{ github.ref_name }}

                      ${{ steps.changelog.outputs.changelog }}

                      ## Installation
                      1. Download the files from the Assets section below
                      2. Copy them to your vault's plugins folder: `<vault>/.obsidian/plugins/xxx/`
                      3. Reload Obsidian
                      4. Enable plugin in settings

            - name: Upload zip file
              id: upload-zip
              uses: actions/upload-release-asset@v1
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  upload_url: ${{ steps.create_release.outputs.upload_url }}
                  asset_path: ./${{ env.PLUGIN_NAME }}.zip
                  asset_name: ${{ env.PLUGIN_NAME }}.zip
                  asset_content_type: application/zip

            - name: Upload main.js
              id: upload-main
              uses: actions/upload-release-asset@v1
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  upload_url: ${{ steps.create_release.outputs.upload_url }}
                  asset_path: ./main.js
                  asset_name: main.js
                  asset_content_type: text/javascript

            - name: Upload manifest.json
              id: upload-manifest
              uses: actions/upload-release-asset@v1
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  upload_url: ${{ steps.create_release.outputs.upload_url }}
                  asset_path: ./manifest.json
                  asset_name: manifest.json
                  asset_content_type: application/json

            - name: Upload styles.css
              id: upload-styles
              uses: actions/upload-release-asset@v1
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  upload_url: ${{ steps.create_release.outputs.upload_url }}
                  asset_path: ./styles.css
                  asset_name: styles.css
                  asset_content_type: text/css
