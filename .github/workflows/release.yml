name: Release Obsidian plugin

on:
    push:
        tags:
            - "[0-9]+.[0-9]+.[0-9]+*" # åŒ¹é…ç±»ä¼¼ 1.0.0 æˆ– 1.0.0-beta.1 çš„æ ¼å¼

permissions:
    contents: write

env:
    PLUGIN_NAME: xxx(replace all occurrences of xxx with your plugin name)

jobs:
    build:
        runs-on: ubuntu-22.04

        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0 # èŽ·å–å®Œæ•´çš„gitåŽ†å²

            - name: Use Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: "18.x"

            - name: Prepare manifest
              id: prepare_manifest
              run: |
                  if [[ ${{ github.ref }} == *"beta"* ]]; then
                    cp manifest-beta.json manifest.json
                  fi

            - name: Build
              id: build
              run: |
                  npm install -g yarn
                  yarn
                  yarn run build --if-present
                  mkdir ${{ env.PLUGIN_NAME }}
                  cp main.js manifest.json styles.css ${{ env.PLUGIN_NAME }}
                  zip -r ${{ env.PLUGIN_NAME }}.zip ${{ env.PLUGIN_NAME }}
                  ls
                  echo "tag_name=$(git tag --sort version:refname | tail -n 1)" >> $GITHUB_OUTPUT

            - name: Generate Changelog
              id: changelog
              run: |
                  # æ£€æŸ¥æ˜¯å¦å­˜åœ¨ä»»ä½•tag
                  if ! git describe --tags > /dev/null 2>&1; then
                    # å¦‚æžœæ²¡æœ‰ä»»ä½•tagï¼Œä½¿ç”¨åˆå§‹commitä½œä¸ºèµ·ç‚¹
                    echo "## ðŸŽ‰ First Release" > temp_changelog.md
                    COMMITS=$(git log --pretty=format:"- %s" --reverse)
                  else
                    # èŽ·å–æœ€æ–°tag
                    LATEST_TAG=$(git describe --tags --abbrev=0)
                    
                    # åˆ¤æ–­å½“å‰æ˜¯å¦ä¸ºbetaç‰ˆæœ¬
                    if [[ $LATEST_TAG == *"-beta"* ]]; then
                      # Betaç‰ˆæœ¬ï¼šæŸ¥æ‰¾ä¸Šä¸€ä¸ªbetaç‰ˆæœ¬tag
                      PREVIOUS_TAG=$(git tag --sort=-version:refname | grep -E ".*-beta.*" | sed -n '2p')
                    else
                      # æ­£å¼ç‰ˆæœ¬ï¼šæŸ¥æ‰¾ä¸Šä¸€ä¸ªæ­£å¼ç‰ˆæœ¬tagï¼ˆä¸åŒ…å«betaï¼‰
                      PREVIOUS_TAG=$(git tag --sort=-version:refname | grep -vE ".*-beta.*" | sed -n '2p')
                    fi
                    
                    if [ ! -z "$PREVIOUS_TAG" ]; then
                      COMMITS=$(git log ${PREVIOUS_TAG}..${LATEST_TAG} --no-merges --pretty=format:"- %s" --reverse)
                    else
                      # å¦‚æžœæ‰¾ä¸åˆ°ä¸Šä¸€ä¸ªå¯¹åº”ç±»åž‹çš„tagï¼Œåˆ™ä½¿ç”¨ç¬¬ä¸€ä¸ªcommit
                      FIRST_COMMIT=$(git rev-list --max-parents=0 HEAD)
                      COMMITS=$(git log ${FIRST_COMMIT}..${LATEST_TAG} --no-merges --pretty=format:"- %s" --reverse)
                    fi
                    
                    echo -e "## Changes\n" > temp_changelog.md
                  fi

                  # å®šä¹‰è¦å¤„ç†çš„commitç±»åž‹
                  TYPES=("feat" "fix" "perf" "refactor" "style" "docs" "test" "chore")

                  for TYPE in "${TYPES[@]}"; do
                    # ä»Žæ‰€æœ‰commitsä¸­è¿‡æ»¤å‡ºç‰¹å®šç±»åž‹çš„commits
                    TYPE_COMMITS=$(echo "$COMMITS" | grep "^- ${TYPE}(" || true)
                    
                    if [ ! -z "$TYPE_COMMITS" ]; then
                      # è½¬æ¢commitç±»åž‹ä¸ºå¯è¯»æ–‡æœ¬
                      case $TYPE in
                        "feat") TITLE="âœ¨ New Features";;
                        "fix") TITLE="ðŸ› Bug Fixes";;
                        "perf") TITLE="âš¡ Performance";;
                        "refactor") TITLE="â™»ï¸ Refactors";;
                        "style") TITLE="ðŸ’„ Styles";;
                        "docs") TITLE="ðŸ“ Documentation";;
                        "test") TITLE="âœ… Tests";;
                        "chore") TITLE="ðŸ”§ Chores";;
                        *) TITLE="Other";;
                      esac
                      
                      # æ·»åŠ åˆ†ç±»æ ‡é¢˜
                      echo -e "\n### ${TITLE}\n" >> temp_changelog.md
                      
                      # å¤„ç†æ¯ä¸ªcommitæ¶ˆæ¯ï¼Œæå–scopeå’Œæè¿°
                      while IFS= read -r COMMIT; do
                        if [[ $COMMIT =~ ^-\ ${TYPE}\((.*?)\):\ (.*)$ ]]; then
                          SCOPE="${BASH_REMATCH[1]}"
                          DESC="${BASH_REMATCH[2]}"
                          echo "- **${SCOPE}**: ${DESC}" >> temp_changelog.md
                        fi
                      done <<< "$TYPE_COMMITS"
                    fi
                  done

                  # å°†å¤„ç†åŽçš„changelogä¿å­˜åˆ°GITHUB_OUTPUT
                  echo "changelog<<EOF" >> $GITHUB_OUTPUT
                  cat temp_changelog.md >> $GITHUB_OUTPUT
                  echo "EOF" >> $GITHUB_OUTPUT

            - name: Create Release
              id: create_release
              uses: actions/create-release@v1
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  tag_name: ${{ github.ref }}
                  release_name: ${{ github.ref }}
                  draft: false
                  prerelease: ${{ contains(github.ref, 'beta') }}
                  body: |
                      ${{ contains(github.ref, 'beta') && 'ðŸš§ This is a beta release' || 'ðŸŽ‰ This is a stable release' }}

                      **Version:** ${{ github.ref_name }}

                      ${{ steps.changelog.outputs.changelog }}

                      ## Installation
                      1. Download the files from the Assets section below
                      2. Copy them to your vault's plugins folder: `<vault>/.obsidian/plugins/xxx/`
                      3. Reload Obsidian
                      4. Enable plugin in settings

            - name: Upload zip file
              id: upload-zip
              uses: actions/upload-release-asset@v1
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  upload_url: ${{ steps.create_release.outputs.upload_url }}
                  asset_path: ./${{ env.PLUGIN_NAME }}.zip
                  asset_name: ${{ env.PLUGIN_NAME }}.zip
                  asset_content_type: application/zip

            - name: Upload main.js
              id: upload-main
              uses: actions/upload-release-asset@v1
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  upload_url: ${{ steps.create_release.outputs.upload_url }}
                  asset_path: ./main.js
                  asset_name: main.js
                  asset_content_type: text/javascript

            - name: Upload manifest.json
              id: upload-manifest
              uses: actions/upload-release-asset@v1
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  upload_url: ${{ steps.create_release.outputs.upload_url }}
                  asset_path: ./manifest.json
                  asset_name: manifest.json
                  asset_content_type: application/json

            - name: Upload styles.css
              id: upload-styles
              uses: actions/upload-release-asset@v1
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  upload_url: ${{ steps.create_release.outputs.upload_url }}
                  asset_path: ./styles.css
                  asset_name: styles.css
                  asset_content_type: text/css
