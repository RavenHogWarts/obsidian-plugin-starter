name: Version Bump Pre-check

# ÂΩìPRË¢´Ê†áËÆ∞‰∏∫ÁâàÊú¨Êõ¥Êñ∞Êó∂ËøõË°åÂÖ®Èù¢ÁöÑÈ¢ÑÊ£ÄÊü•
on:
    pull_request:
        types: [labeled, synchronize, reopened]

permissions:
    contents: read
    pull-requests: write

env:
    PLUGIN_ID: obsidian-plugin-starter # ÊõøÊç¢‰∏∫‰Ω†ÁöÑÊèí‰ª∂ ID

jobs:
    version-bump-precheck:
        if: contains(github.event.pull_request.labels.*.name, 'version-bump')
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "18.x"
                  cache: "npm"

            - name: Prepare manifest
              id: prepare_manifest
              run: |
                  if [[ ${{ github.ref }} == *"beta"* ]]; then
                    cp manifest-beta.json manifest.json
                  fi

            - name: Install dependencies
              run: |
                  npm install -g yarn
                  yarn

            - name: Run comprehensive checks
              id: checks
              run: |
                  echo "üîç Starting comprehensive pre-version-bump checks..."

                  # ‰ΩøÁî®‰∏é release ‰∏ÄËá¥ÁöÑÊûÑÂª∫ÊñπÊ≥ï
                  echo "üìù Building plugin..."
                  if yarn run build --if-present; then
                    echo "‚úÖ Build successful"
                    echo "build_check=‚úÖ" >> $GITHUB_OUTPUT
                  else
                    echo "‚ùå Build failed"
                    echo "build_check=‚ùå" >> $GITHUB_OUTPUT
                    exit 1
                  fi

                  # ÊûÑÂª∫‰∫ßÁâ©Ê£ÄÊü•
                  echo "üì¶ Verifying build artifacts..."
                  required_files=("main.js" "manifest.json" "styles.css")
                  missing_files=()

                  for file in "${required_files[@]}"; do
                    if [ ! -f "$file" ]; then
                      missing_files+=("$file")
                    fi
                  done

                  if [ ${#missing_files[@]} -eq 0 ]; then
                    echo "‚úÖ All required build artifacts found"
                    echo "artifacts_check=‚úÖ" >> $GITHUB_OUTPUT
                  else
                    echo "‚ùå Missing build artifacts: ${missing_files[*]}"
                    echo "artifacts_check=‚ùå" >> $GITHUB_OUTPUT
                    exit 1
                  fi

                  # ÁâàÊú¨‰∏ÄËá¥ÊÄßÊ£ÄÊü•
                  echo "üî¢ Checking version consistency..."
                  package_version=$(node -p "require('./package.json').version")
                  manifest_version=$(node -p "require('./manifest.json').version")

                  echo "Package.json version: $package_version"
                  echo "Manifest.json version: $manifest_version"

                  if [ "$package_version" = "$manifest_version" ]; then
                    echo "‚úÖ Version consistency check passed"
                    echo "version_check=‚úÖ" >> $GITHUB_OUTPUT
                  else
                    echo "‚ùå Version mismatch between package.json and manifest.json"
                    echo "version_check=‚ùå" >> $GITHUB_OUTPUT
                    exit 1
                  fi

            - name: Generate check report
              if: always()
              run: |
                  echo "üìä Pre-version-bump Check Report"
                  echo "================================="
                  echo "Build: ${{ steps.checks.outputs.build_check }}"
                  echo "Build Artifacts: ${{ steps.checks.outputs.artifacts_check }}"
                  echo "Version Consistency: ${{ steps.checks.outputs.version_check }}"

            - name: Find previous precheck comment
              if: always()
              uses: peter-evans/find-comment@v3
              id: fc
              with:
                  issue-number: ${{ github.event.pull_request.number }}
                  comment-author: "github-actions[bot]"
                  body-includes: "## Version Bump Pre-check"

            - name: Create or update success comment
              if: success()
              uses: peter-evans/create-or-update-comment@v4
              with:
                  comment-id: ${{ steps.fc.outputs.comment-id }}
                  issue-number: ${{ github.event.pull_request.number }}
                  body: |
                      ## Version Bump Pre-check Passed!

                      All checks have completed successfully. This PR is ready for version bump.

                      ### Check Results:
                      - ${{ steps.checks.outputs.build_check }} Build & Compilation
                      - ${{ steps.checks.outputs.artifacts_check }} Build Artifacts
                      - ${{ steps.checks.outputs.version_check }} Version Consistency

                      You can now safely proceed with version bump and release.

            - name: Create or update failure comment
              if: failure()
              uses: peter-evans/create-or-update-comment@v4
              with:
                  comment-id: ${{ steps.fc.outputs.comment-id }}
                  issue-number: ${{ github.event.pull_request.number }}
                  body: |
                      ## Version Bump Pre-check Failed!

                      Some checks have failed. Please review and fix the issues before proceeding with version bump.

                      ### Check Results:
                      - ${{ steps.checks.outputs.build_check || '‚ùì' }} Build & Compilation
                      - ${{ steps.checks.outputs.artifacts_check || '‚ùì' }} Build Artifacts
                      - ${{ steps.checks.outputs.version_check || '‚ùì' }} Version Consistency

                      Please check the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for detailed error information.
